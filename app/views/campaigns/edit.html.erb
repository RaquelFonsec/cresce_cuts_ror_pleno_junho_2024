<!-- app/views/campaigns/edit.html.erb -->
<div class="container mt-5">
  <h1 class="mb-4">Edit Campaign</h1>

  <%= form_for @campaign, html: { class: "form", multipart: true } do |f| %>
    <% if @campaign.errors.any? %>
      <div id="error_explanation" class="alert alert-danger">
        <h2><%= pluralize(@campaign.errors.count, "error") %> prohibited this campaign from being saved:</h2>
        <ul>
          <% @campaign.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div class="form-group">
      <%= f.label :product_id, "Product", class: "form-label" %>
      <%= f.collection_select :product_id, @products, :id, :name, { prompt: "Select a product" }, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :description, class: "form-label" %>
      <%= f.text_area :description, class: "form-control", placeholder: "Enter description" %>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <%= f.label :original_price, "Original Price", class: "form-label" %>
        <%= f.text_field :original_price, class: "form-control", readonly: true, value: number_to_currency(@campaign.original_price) %>
      </div>

      <div class="form-group col-md-6">
        <%= f.label :discounted_price, "Discounted Price", class: "form-label" %>
        <%= f.text_field :discounted_price, class: "form-control", readonly: true, value: number_to_currency(@campaign.discounted_price) %>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-6">
        <%= f.label :start_date, class: "form-label" %>
        <%= f.date_field :start_date, class: "form-control" %>
      </div>

      <div class="form-group col-md-6">
        <%= f.label :end_date, class: "form-label" %>
        <%= f.date_field :end_date, class: "form-control" %>
      </div>
    </div>

    <!-- Adicionando os campos de desconto dentro de fields_for -->
    <%= f.fields_for :discount do |discount_form| %>
      <div class="form-group">
        <%= discount_form.label :discount_type, "Discount Type", class: "form-label" %>
        <%= discount_form.select :discount_type, [['Percentage', 'percentual'], ['Fixed Amount', 'valor_fixo']], { prompt: "Select discount type" }, class: "form-control" %>
      </div>

      <div class="form-group">
        <%= discount_form.label :discount_value, "Discount Value", class: "form-label" %>
        <%= discount_form.text_field :discount_value, class: "form-control" %>
      </div>
    <% end %>

    <div class="form-group">
      <%= f.label :status, "Status", class: "form-label" %>
      <%= f.select :status, Campaign.statuses.keys.map { |status| [status.titleize, status] }, { prompt: "Select status" }, class: "form-control" %>
    </div>

    <div class="form-group">
      <%= f.label :image, "Upload Image", class: "form-label" %>
      <%= f.file_field :image, class: "form-control-file" %>
    </div>

    <div class="form-group">
      <%= f.submit "Save Changes", class: "btn btn-primary mr-2" %>
      <%= link_to 'Back to Campaigns', campaigns_path, class: "btn btn-secondary" %>
    </div>
  <% end %>
</div>

<script>
  // Script para recalcular o preço com desconto ao editar o tipo ou valor do desconto
  document.addEventListener("DOMContentLoaded", function() {
    const originalPriceField = document.getElementById("campaign_original_price");
    const discountedPriceField = document.getElementById("campaign_discounted_price");
    const discountTypeField = document.getElementById("campaign_discount_attributes_discount_type");
    const discountValueField = document.getElementById("campaign_discount_attributes_discount_value");

    function updateDiscountedPrice() {
      const originalPrice = parseFloat(originalPriceField.value.replace(/[^0-9.-]+/g,""));
      const discountType = discountTypeField.value;
      const discountValue = parseFloat(discountValueField.value.replace(/[^0-9.-]+/g,""));

      let discountedPrice = originalPrice;

      if (discountType === "percentual") {
        discountedPrice = originalPrice * (1 - discountValue / 100);
      } else if (discountType === "valor_fixo") {
        discountedPrice = originalPrice - discountValue;
      }

      discountedPriceField.value = discountedPrice.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    discountTypeField.addEventListener("change", updateDiscountedPrice);
    discountValueField.addEventListener("input", updateDiscountedPrice);

    // Executa o cálculo inicial ao carregar a página
    updateDiscountedPrice();
  });
</script>

